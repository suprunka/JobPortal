@model MyWeb.Models.ViewDetails
@using Microsoft.AspNet.Identity;
@using DayPilot.Web.Mvc
@using DayPilot.Web.Mvc.Events.Calendar
@using ViewType = DayPilot.Web.Mvc.Enums.Calendar.ViewType

@{
    ViewBag.Title = "ViewDetails";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

@using (Html.BeginForm())
{
    @Html.AntiForgeryToken()
    @Html.HiddenFor(model => model.Id)

    <div class="offerCard">
        <h2>Offer details</h2>

        <hr />
        @Html.ValidationSummary(true, "", new { @class = "text-danger" })

        <div class="form-group">
            @Html.LabelFor(model => model.Title)

            <div class="col-md-12" id="edit">
                @Html.EditorFor(model => model.Title)
                @Html.ValidationMessageFor(model => model.Title, "", new { @class = "text-danger" })
            </div>
        </div>
        <div class="form-group">
            @Html.LabelFor(model => model.RatePerHour)

            <div class="col-md-12" id="edit">
                @Html.EditorFor(model => model.RatePerHour)
                @Html.ValidationMessageFor(model => model.RatePerHour, "", new { @class = "text-danger" })
            </div>
        </div>
        <div class="form-group">
            @Html.LabelFor(model => model.Description)

            <div class="col-md-12" id="edit">
                @Html.TextAreaFor(model => model.Description, new { style = "width:250px; word-break:break-word;" })
                @Html.ValidationMessageFor(model => model.Description, "", new { @class = "text-danger" })
            </div>
        </div>

        <div class="form-group">
            @Html.ActionLink("See an author of the service offer", "UserProfile", "User", new { id = Model.Author }, null)
        </div>

        @if (Model.Author == User.Identity.GetUserId())
        {
            <div class="form-group">
                <div class="col-md-offset-2 col-md-10">
                    <input type="submit" value="Save" class="btn btn-primary" />
                    @Html.ActionLink("Delete", "Delete", "ServiceOffer", new { idd = Model.Id }, new { @class = "btn btn-danger" })
                </div>
            </div>
            <br />

            <script src="@Url.Content("~/Scripts/daypilot-all.min.js")" type="text/javascript"></script>

            <div id="dp">
                <br />
                <br />
                <br />


                @Html.DayPilotCalendar("dpc", new DayPilotCalendarConfig
           {
               BackendUrl = Url.Action("Backend", "Calendar",new {serviceId = Model.Id }),
               ViewType = ViewType.Week,
               CellDuration = 60,
               Height = 600,
               CellHeight = 30,
               HeightSpec = DayPilot.Web.Mvc.Enums.Calendar.HeightSpec.Full,
               DayBeginsHour= 5,
               DayEndsHour= 22,
               DurationBarVisible = true,
               TimeRangeSelectedHandling = TimeRangeSelectedHandlingType.JavaScript,
               TimeRangeSelectedJavaScript = "create(start, end)",
               EventClickHandling = EventClickHandlingType.JavaScript,
               EventClickJavaScript = "edit(e)",
               EventMoveHandling = EventMoveHandlingType.Notify,
               EventResizeHandling = EventResizeHandlingType.Notify,
               EventDeleteHandling = EventDeleteHandlingType.CallBack,
               HeaderDateFormat = "dddd",

           })

            </div>

        }
        else
        {
            <h3>Book a service offer.</h3>
            <div class="col-md-10">

                Available days when you can order the service:
                <div>
                    @foreach (var t in Model.Dates)
                    {
                        <div>
                            @t.WeekDay.ToString()s
                        </div>
                    }
                </div>
                <input type="date" name="days" id="selecteddate">
                <br />





                @Html.DropDownList("Hours from", new SelectList(""), new { @id = "hoursfrom", @class = "form-control" })

                @Html.DropDownList("Hours To", new SelectList(""), new { @id = "hoursto", @class = "form-control" })

                @Html.ActionLink("Add to cart", "AddToCart", "Order", new { serviceID = Model.Id, userID = User.Identity.GetUserId() }, new { @class = "btn btn-danger", @id = "addToCart" })




            </div>


        }
    </div>
}
@Html.Raw(TempData["msg"])
<script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>

<script>

    $('#selecteddate').change(function () {
        var selectedDate = $("#selecteddate").val();
        var hourFrom = $('#hoursfrom');
        hourFrom.empty();
        console.log(selectedDate);
        if (selectedDate != null && selectedDate != '') {
            $.getJSON('@Url.Action("GetHoursFrom")', { serviceId: @Model.Id, date: selectedDate }, function (sub) {
                        if (sub != null && !jQuery.isEmptyObject(sub))
                        {
                            console.log(selectedDate);

                            hourFrom.append($('<option/>', {
                                value: null,
                                text: ""
                            }));
                            $.each(sub, function (index, subcats) {
                                console.log(subcats);

                                hourFrom.append($('<option/>', {
                                    value: subcats.Value,
                                    text: subcats.Text
                                }));
                            });
                        };
                    });
                }
            });


    $('#hoursfrom').change(function () {
        var selectedDate = $("#selecteddate").val();
        var selectedHour= $("#hoursfrom").val();
        var hourto = $('#hoursto');

        hourto.empty();
        if (selectedDate != null && selectedDate != '') {

            $.getJSON('@Url.Action("GetHoursTo")', { serviceId: @Model.Id, date: selectedDate, from: selectedHour }, function (sub) {
                console.log(sub);

                        if (sub != null && !jQuery.isEmptyObject(sub))
                        {
                            console.log(selectedDate);

                            hourto.append($('<option/>', {
                                value: null,
                                text: ""
                            }));
                            $.each(sub, function (index, subcats) {

                                hourto.append($('<option/>', {
                                    value: subcats.Value,
                                    text: subcats.Text
                                }));
                            });
                        };
                    });
                }
    });
      $('#addToCart').click(function () {
        var date = $('#selecteddate').val();
        var from = $('#hoursfrom').val();
        var to = $('#hoursto').val();
        var path = '@Url.Content("~/Order/AddToCart")' + "?serviceID=@Model.Id+&userID=@User.Identity.GetUserId()+&date=" + date + "+&from=" + from + "+&to=" + to;
        $(this).attr("href", path);
    });


</script>

<script type="text/javascript">

    function create(start, end) {

        var m = new DayPilot.Modal();
        m.closed = function () {
            if (this.result == "Hours are added") {
                dp.commandCallBack('refresh');
            }

            dp.clearSelection();
        };

        m.showUrl('@Url.Action("AddHours", "Calendar")?startT=' + start + '&endT=' + end + '&serviceId='+@Model.Id );
    }

    function edit(e) {
        var m = new DayPilot.Modal();
        m.closed = function () {
            if (this.result == "OK") {
                dp.commandCallBack('refresh');
            }
            dp.clearSelection();
        };
        m.showUrl('@Url.Action("Edit", "Event")/' + e.id());
    }

</script>
